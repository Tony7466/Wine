#!/usr/bin/make -f
export DH_VERBOSE=1

LIBDIR=usr/lib/$(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
VERSUFFIX=$(shell dpkg-parsechangelog | grep ^Source | cut -d\  -f2 | sed s/wine//g)

# configure options
CONFIGURE=--without-hal \
          --libdir=/$(LIBDIR)/wine-unstable \
          LDFLAGS=-Wl,-rpath,/$(LIBDIR)/wine-unstable \

# 32-bit parameters
BIT=32
ifeq (,$(VERSUFFIX))
ALTPRIO := 100
else
ALTPRIO := 50
endif 

# 64-bit parameters
ifeq ($(DEB_BUILD_ARCH), amd64)
BIT=64
CONFIGURE+=--enable-win64 # enable wine64 on amd64
ifeq (,$(VERSUFFIX))
ALTPRIO := 125
else
ALTPRIO := 75
endif
endif

# add in version suffix
MAKEFLAGS+=LIBSUFFIX="$(VERSUFFIX)" DATASUFFIX="$(VERSUFFIX)"

# handle parallel build options
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
MAKEFLAGS+=-j$(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
endif

debian/control: debian/control.in
	sed -e 's/\(wine[a-z0-9_-]*\)/\1$(VERSUFFIX)/g' \
	    -e 's/\(gecko[a-z0-9_-]*\)$(VERSUFFIX)/\1/' \
	    -e 's/pkg-wine$(VERSUFFIX)\/wine$(VERSUFFIX)\.git/pkg-wine\/wine.git/g' \
	    -e 's/pkg-wine-party$(VERSUFFIX)/pkg-wine-party/g' \
	    -e 's/wine64-bin$(VERSUFFIX)/wine64-bin/g' \
	    -e 's/winehq$(VERSUFFIX)/winehq/g' \
	    -e 's/wine-doc$(VERSUFFIX)/wine-doc/g' $< > $@
%:
	dh $@

override_dh_auto_configure:
	ln -s /usr/share/misc/config.sub tools/config.sub
	ln -s /usr/share/misc/config.guess tools/config.guess
	dh_auto_configure -- $(CONFIGURE)

override_dh_auto_build:
	test "$(BIT)" != "32" || $(MAKE)

override_dh_install:
	bash debian/prep-install.sh "$(VERSUFFIX)" "$(LIBDIR)"
	bash debian/gen-alternatives.sh "$(VERSUFFIX)" $(BIT) $(ALTPRIO)
	cp server/wineserver debian/tmp/$(LIBDIR)/wine$(VERSUFFIX)/wine
	cp tools/winedump/README debian/README.winedump
	dh_install

override_dh_auto_test:
	# disable upstream's automated testing due to various brokenness

override_dh_strip:
	dh_strip -Xwine-pthread -Xwine-kthread \
	    --dbg-package=libwine-dbg$(VERSUFFIX)
	rm -rf debian/libwine-dbg$(VERSUFFIX)/usr/lib/debug/usr/bin

override_dh_auto_clean: debian/control
	test ! -e Makefile || $(MAKE) distclean
	rm -f debian/README.winedump libs/wine/libwine$(VERSUFFIX).so.*
	rm -f tools/config.sub tools/config.guess tools/makedep
	bash debian/clean-install.sh "$(VERSUFFIX)"
