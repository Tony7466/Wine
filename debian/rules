#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.
export SHELL=bash

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
CFLAGS=-O0 -g
else
CFLAGS=-O2 -g
endif

CONFIGOPTS = --with-x --enable-opengl

DEB_HOST_GNU_SYSTEM	?= $(shell dpkg-architecture -qDEB_HOST_GNU_SYSTEM)
DEB_HOST_GNU_CPU	?= $(shell dpkg-architecture -qDEB_HOST_GNU_CPU)

# On amd64, build 32-bit package by simply unpacking amd64.tar.lzma.uu
# if it exists, otherwise build from source using 32-bit compiler.

ifeq ($(DEB_HOST_GNU_CPU), x86_64)
ifeq ($(DEB_HOST_GNU_SYSTEM), linux-gnu)
ifneq (,$(wildcard debian/amd64.tar.lzma.uu))
AMD64_COPY = true
endif
endif
ifeq (,$(AMD64_COPY))
BUILD_TARGETS = build-arch32
INSTALL_TARGETS = install-arch32
CLEAN_TARGETS = clean32
else
BUILD_TARGETS =
INSTALL_TARGETS =
CLEAN_TARGETS =
endif
# Not ready yet: build Win64 version
#BUILD_TARGETS += build-arch64
#INSTALL_TARGETS += install-arch64
#CLEAN_TARGETS += clean64
#NATIVE_BUILD = build64
NATIVE_BUILD = build32
else
BUILD_TARGETS = build-arch32
INSTALL_TARGETS = install-arch32
CLEAN_TARGETS = clean32
NATIVE_BUILD = build32
endif

configure32: configure32-stamp
configure32-stamp:
	dh_testdir
ifeq (,$(DEB_SAVEBUILD))
	mkdir build32 || true
	cd build32 && \
	CFLAGS="$(CFLAGS)" \
	../configure --disable-win64 $(CONFIGOPTS) \
	--prefix=/usr \
	--sysconfdir=/etc \
	--bindir=\$${prefix}/bin \
	--libdir=\$${prefix}/lib \
	--mandir=\$${prefix}/share/man \
	--infodir=\$${prefix}/share/info
else
	mv /tmp/build32 .
endif

	touch configure32-stamp

configure64: configure64-stamp
configure64-stamp:
	dh_testdir
ifeq (,$(DEB_SAVEBUILD))
	mkdir build64 || true
	cd build64 && \
	CFLAGS="$(CFLAGS)" \
	../configure --enable-win64 $(CONFIGOPTS) \
	--prefix=/usr \
	--sysconfdir=/etc \
	--bindir=\$${prefix}/bin \
	--libdir=\$${prefix}/lib \
	--mandir=\$${prefix}/share/man \
	--infodir=\$${prefix}/share/info
else
	mv /tmp/build64 .
endif

	touch configure64-stamp

build-indep: build-indep-stamp
build-indep-stamp: $(subst build,configure,$(NATIVE_BUILD))
	dh_testdir

	touch build-indep-stamp

build-arch32: build-arch32-stamp
build-arch32-stamp: configure32-stamp
	dh_testdir

ifeq (,$(DEB_SAVEBUILD))
	$(MAKE) -C build32 depend
	# build wine & tools
	$(MAKE) -C build32
	# build winelib programs
	$(MAKE) -C build32/programs
endif

	touch build-arch32-stamp

build-arch64: build-arch64-stamp
build-arch64-stamp: configure64-stamp
	dh_testdir

ifeq (,$(DEB_SAVEBUILD))
	$(MAKE) -C build64 depend
	# build wine & tools
	$(MAKE) -C build64
	# build winelib programs
	$(MAKE) -C build64/programs
endif

	touch build-arch64-stamp

build-arch: $(BUILD_TARGETS)
build: build-indep build-arch

clean32:
	dh_testdir
	dh_testroot
	rm -f build-arch32-stamp configure32-stamp
#	-$(MAKE) -C build32 distclean
ifeq (,$(DEB_SAVEBUILD))
	rm -rf build32
else
	mv build32 /tmp
endif

clean64:
	dh_testdir
	dh_testroot
	rm -f build-arch64-stamp configure64-stamp
#	-$(MAKE) -C build64 distclean
ifeq (,$(DEB_SAVEBUILD))
	rm -rf build64
else
	mv build64 /tmp
endif

clean: $(CLEAN_TARGETS)
	dh_testdir
	dh_testroot
	rm -f build-indep-stamp
	dh_clean

install-indep: build-indep
	dh_testdir
	dh_testroot
	dh_installdirs -i

install-arch32: build-arch32
	dh_testdir
	dh_testroot

	# install wine, libwine, and tools
	$(MAKE) -C build32 install prefix=`pwd`/debian/tmp/usr libdir=`pwd`/debian/tmp/usr/lib
	# move the real binaries into /usr/lib/wine,
	# wrapping them with the winelauncher
	mv debian/tmp/usr/bin/wine debian/tmp/usr/lib/wine/wine.bin
	mv debian/tmp/usr/bin/wine-kthread debian/tmp/usr/lib/wine/wine-kthread
	mv debian/tmp/usr/bin/wine-pthread debian/tmp/usr/lib/wine/wine-pthread
	mv debian/tmp/usr/bin/wine-preloader debian/tmp/usr/lib/wine/wine-preloader
	mv debian/tmp/usr/bin/wineserver debian/tmp/usr/lib/wine/wineserver
	mv debian/tmp/usr/bin/winelauncher debian/tmp/usr/bin/wine
	# install manpages
	$(MAKE) -C build32/documentation install prefix=`pwd`/debian/tmp/usr
	mv debian/tmp/usr/share/man/man3w debian/tmp/usr/share/man/man3
	# install winelib programs
	$(MAKE) -C build32/programs install prefix=`pwd`/debian/tmp/usr
	install build32/tools/fnt2bdf debian/tmp/usr/bin

# I still have to work out how to install 32-bit and 64-bit Wine side by side.
# This version only works if the 32-bit version isn't installed...
install-arch64: build-arch64
	dh_testdir
	dh_testroot

	# install wine, libwine, and tools
	$(MAKE) -C build64 install prefix=`pwd`/debian/tmp/usr libdir=`pwd`/debian/tmp/usr/lib
	# move the real binaries into /usr/lib/wine,
	# wrapping them with the winelauncher
	mv debian/tmp/usr/bin/wine debian/tmp/usr/lib/wine/wine.bin
	mv debian/tmp/usr/bin/wineserver debian/tmp/usr/lib/wine/wineserver
	mv debian/tmp/usr/bin/winelauncher debian/tmp/usr/bin/wine
	# install manpages
	$(MAKE) -C build64/documentation install prefix=`pwd`/debian/tmp/usr
	mv debian/tmp/usr/share/man/man3w debian/tmp/usr/share/man/man3
	# install winelib programs
	$(MAKE) -C build64/programs install prefix=`pwd`/debian/tmp/usr
	install build64/tools/fnt2bdf debian/tmp/usr/bin

install-arch: $(INSTALL_TARGETS)
	dh_testdir
	dh_testroot

	mkdir -p debian/tmp/usr/share/{mime-info,binfmts}
	cp debian/mime-info.mime	debian/tmp/usr/share/mime-info/wine.mime
	cp debian/mime-info.keys	debian/tmp/usr/share/mime-info/wine.keys
	cp debian/wine.binfmt		debian/tmp/usr/share/binfmts/wine
	# other documentation
	mkdir -p debian/tmp/usr/share/doc/wine
	cp dlls/twain_32/README		debian/tmp/usr/share/doc/wine/README.twain
	cp tools/winedump/README	debian/tmp/usr/share/doc/wine/README.winedump

install: install-arch

# Build architecture-independent files here.
binary-indep: build-indep install-indep
	dh_testdir
	dh_testroot

	dh_installdocs -i
	dh_installchangelogs -i ChangeLog
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

# Build architecture-dependent files here.
binary-arch: install-arch
	dh_testdir
	dh_testroot
	# create installation directories
	dh_installdirs -s

ifeq (,$(AMD64_COPY))
	# distribute files into debian/<packagename>
	# according to the <packagename>.install files
	dh_install -s

	# split up libwine
ifeq ($(DEB_HOST_GNU_SYSTEM), linux-gnu)
	mv debian/libwine/usr/lib/wine/winealsa* debian/libwine-alsa/usr/lib/wine
	mv debian/libwine/usr/lib/wine/capi*     debian/libwine-capi/usr/lib/wine
endif
	mv debian/libwine/usr/lib/wine/mscms*    debian/libwine-cms/usr/lib/wine
	mv debian/libwine/usr/lib/wine/wineoss*  debian/libwine-oss/usr/lib/wine
	mv debian/libwine/usr/lib/wine/wineesd*  debian/libwine-esd/usr/lib/wine
	mv debian/libwine/usr/lib/wine/d3d8*     debian/libwine-gl/usr/lib/wine
	mv debian/libwine/usr/lib/wine/d3d9*     debian/libwine-gl/usr/lib/wine
	mv debian/libwine/usr/lib/wine/d3d10*    debian/libwine-gl/usr/lib/wine
	mv debian/libwine/usr/lib/wine/d3dim*    debian/libwine-gl/usr/lib/wine
	mv debian/libwine/usr/lib/wine/d3drm*    debian/libwine-gl/usr/lib/wine
	mv debian/libwine/usr/lib/wine/d3dx8*    debian/libwine-gl/usr/lib/wine
	mv debian/libwine/usr/lib/wine/d3dxof*   debian/libwine-gl/usr/lib/wine
	mv debian/libwine/usr/lib/wine/glu32*    debian/libwine-gl/usr/lib/wine
	mv debian/libwine/usr/lib/wine/opengl32* debian/libwine-gl/usr/lib/wine
	mv debian/libwine/usr/lib/wine/wined3d*  debian/libwine-gl/usr/lib/wine
	mv debian/libwine/usr/lib/wine/winejack* debian/libwine-jack/usr/lib/wine
	mv debian/libwine/usr/lib/wine/wldap32*  debian/libwine-ldap/usr/lib/wine
	mv debian/libwine/usr/lib/wine/winenas*  debian/libwine-nas/usr/lib/wine
	mv debian/libwine/usr/lib/wine/wineps*   debian/libwine-print/usr/lib/wine
endif

	dh_installdocs -s
#	dh_installmenu -s
	dh_installmime -s

	dh_undocumented -s
	dh_installchangelogs -s ChangeLog
	dh_link -s
	dh_strip -s
	dh_compress -s
	dh_fixperms -s

ifneq (,$(AMD64_COPY))
	# Using compressed 32-bit build.  Make sure it's the latest one!!
	uudecode < debian/amd64.tar.lzma.uu | lzma -d | tar -xpf -
endif
ifeq ($(DEB_HOST_GNU_CPU)-$(DEB_HOST_GNU_SYSTEM), i486-linux-gnu)
	# Generating compressed 32-bit build.  Make sure to keep your *_i386.deb in sync with this file in your *.diff.gz!!
	tar -cpf - `grep-dctrl -v "Architecture: all" debian/control | grep "^Package: " | sed -e "s,^Package: ,debian/,g"` \
		| lzma -c9 | uuencode - > debian/amd64.tar.lzma.uu
ifneq (,$(DEB_FIXDIFF))
	# okay, try to change the .diff.gz
	sh debian/diff-amd64.sh
endif
endif

	dh_makeshlibs -s
	dh_installdeb -s
	dh_shlibdeps -s -L libwine -l$(NATIVE_BUILD)/libs/wine

	# if the distro we're compiling for has freetype, depend on it
ifneq ($(DEB_HOST_GNU_CPU), x86_64)
	(dpkg -s libfreetype6-dev >/dev/null && \
	 echo "freetype=, libfreetype6" >> debian/libwine.substvars && \
	 echo "freetype=, libfreetype6" >> debian/libwine-print.substvars) || \
	true

	# if the distro we're compiling for has cups, depend on it
	(dpkg -s libcupsys2-dev >/dev/null && \
	 echo "cupsys=, libcupsys2-gnutls10 | libcupsys2" >> debian/libwine-print.substvars) || \
	true

	# if the distro we're compiling for has jack, depend on it
	(dpkg -s libjack0.100.0-dev >/dev/null && \
	 echo "jack=, libjack0.100.0-0" >> debian/libwine-jack.substvars) || \
	(dpkg -s libjack0.80.0-dev >/dev/null && \
	 echo "jack=, libjack0.80.0-0" >> debian/libwine-jack.substvars) || \
	(dpkg -s libjack0.71.2-dev >/dev/null && \
	 echo "jack=, libjack0.71.2-0" >> debian/libwine-jack.substvars) || \
	(dpkg -s libjack0.50.0-dev >/dev/null && \
	 echo "jack=, libjack0.50.0-0" >> debian/libwine-jack.substvars) || \
	true
endif

	dh_gencontrol -s
	dh_md5sums -s
	dh_builddeb -s

binary: binary-arch binary-indep

.PHONY: configure32 configure64 \
	build-indep build-arch32 build-arch64 build-arch build \
	clean32 clean64 clean \
	install-indep install-arch32 install-arch64 install-arch install \
	binary-indep binary-arch binary
