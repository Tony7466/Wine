#!/usr/bin/make -f
export DH_VERBOSE=1

VERSUFFIX=$(shell dpkg-parsechangelog | grep ^Source | cut -d\  -f2 | sed s/wine//g)
DEB_HOST_MULTIARCH=$(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
LIBDIR=usr/lib/$(DEB_HOST_MULTIARCH)

# configure options
CONFIGURE=--libdir=/$(LIBDIR)/wine-unstable \
	  --without-hal \
	  LDFLAGS=-Wl,-rpath,/$(LIBDIR)/wine-unstable

# 32-bit parameters
BIT=32
ifeq (,$(VERSUFFIX))
ALTPRIO := 100
else
ALTPRIO := 50
endif 

# 64-bit parameters
ifeq ($(DEB_BUILD_ARCH), amd64)
BIT=64
CONFIGURE+=--enable-win64 # enable wine64 on amd64
ifeq (,$(VERSUFFIX))
ALTPRIO := 125
else
ALTPRIO := 75
endif
endif

# handle parallel build options
JOBS=
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
JOBS=-j$(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
endif

%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure -- $(CONFIGURE)

override_dh_auto_build:
	test "$(BIT)" != "32" || make $(JOBS)

override_dh_install:
	bash debian/prep-install.sh "$(VERSUFFIX)" "$(LIBDIR)"
	bash debian/gen-alternatives.sh "$(VERSUFFIX)" $(BIT) $(ALTPRIO)
	cp server/wineserver debian/tmp/$(LIBDIR)/wine$(VERSUFFIX)/wine
	#for file in debian/tmp/$(LIBDIR)/wine$(VERSUFFIX)/wine/*.so; do \
	    chrpath -r '$$ORIGIN/..' $$file; done
	mv debian/tmp/usr/share/wine debian/tmp/usr/share/wine$(VERSUFFIX) || true
	cp tools/winedump/README debian/README.winedump
	dh_install

override_dh_auto_test:
	# disable upstream's automated testing due to brokenness

override_dh_strip:
	dh_strip -Xwine-pthread -Xwine-kthread

override_dh_auto_clean:
	dh_auto_clean
	rm -f debian/README.winedump
	bash debian/clean-install.sh "$(VERSUFFIX)"
	sed -e 's/\(wine[a-z0-9_-]*\)/\1$(VERSUFFIX)/g' \
	    -e 's/\(gecko[a-z0-9_-]*\)$(VERSUFFIX)/\1/' \
	    -e 's/pkg-wine$(VERSUFFIX)\/wine$(VERSUFFIX)\.git/pkg-wine\/wine.git/g' \
	    -e 's/pkg-wine-party$(VERSUFFIX)/pkg-wine-party/g' \
	    -e 's/wine64-bin$(VERSUFFIX)/wine64-bin/g' \
	    -e 's/winehq$(VERSUFFIX)/winehq/g' \
	    -e 's/wine-doc$(VERSUFFIX)/wine-doc/g' debian/control.in > debian/control	
